/** .github/workflows/remote-integrity-check.yml */

name: Omnisync Remote Integrity (Manual)

# Se activa exclusivamente de forma manual para controlar el consumo de recursos Cloud
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Motivo de la auditoría manual'
        required: false
        default: 'Validación de nivelación de aparato'

jobs:
  cloud-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install PNPM
        run: npm install -g pnpm

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Atomic Tests
        run: pnpm nx run-many -t test --all
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          GOOGLE_GEMINI_API_KEY: ${{ secrets.GOOGLE_GEMINI_API_KEY }}