# .github/workflows/remote-integrity-check.yml
name: Omnisync Remote Integrity (Manual)

# EjecuciÃ³n estrictamente manual para control de costos y recursos
on:
  workflow_dispatch:
    inputs:
      audit_reason:
        description: 'Motivo de la auditorÃ­a manual'
        required: true
        default: 'VerificaciÃ³n de NivelaciÃ³n de Aparato'

jobs:
  validate-neural-infrastructure:
    runs-on: ubuntu-latest
    
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
      UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
      GOOGLE_GEMINI_API_KEY: ${{ secrets.GOOGLE_GEMINI_API_KEY }}
      QDRANT_URL: ${{ secrets.QDRANT_URL }}
      QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}

    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js (V22)
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ğŸ“¦ Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: ğŸ“¥ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—„ï¸ Database DNA Sync (Prisma)
        run: npx prisma db push --schema=libs/core/persistence/prisma/schema.prisma

      - name: ğŸ—ï¸ Nx Atomic Build
        run: npx nx run-many -t build --all

      - name: ğŸ§ª Mirror Testing (Logic Validation)
        run: npx nx run-many -t test --all